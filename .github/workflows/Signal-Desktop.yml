name: Signal-Desktop

on: [push]

env:
  VERSION: 7.64.0

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Build
        id: hash
        run: |
          git clone https://github.com/signalapp/Signal-Desktop -b v${{ env.VERSION }} --depth 1
          cd Signal-Desktop/reproducible-builds
          chmod +x build.sh
          ./build.sh public
          echo "HASH=$(sha256sum ../release/signal-desktop_${{ env.VERSION }}_amd64.deb | awk '{print $1}')" >> $GITHUB_OUTPUT
    outputs:
      HASH: ${{ steps.hash.outputs.HASH }}

  official:
    runs-on: ubuntu-latest
    steps:
      - name: Install Signal repos
        run: |
          wget -O- https://updates.signal.org/desktop/apt/keys.asc | gpg --dearmor > signal-desktop-keyring.gpg;
          cat signal-desktop-keyring.gpg | sudo tee /usr/share/keyrings/signal-desktop-keyring.gpg > /dev/null
          wget -O signal-desktop.sources https://updates.signal.org/static/desktop/apt/signal-desktop.sources;
          cat signal-desktop.sources | sudo tee /etc/apt/sources.list.d/signal-desktop.sources > /dev/null
          sudo apt-get update
      - name: Download official .deb
        id: hash
        run: |
          apt-get download signal-desktop=${{ env.VERSION }}
          echo "HASH=$(sha256sum signal-desktop_${{ env.VERSION }}_amd64.deb | awk '{print $1}')" >> $GITHUB_OUTPUT
    outputs:
      HASH: ${{ steps.hash.outputs.HASH }}

  check:
    runs-on: ubuntu-latest
    needs: [build, official]
    steps:
      - name: Check hashes
        run: |
          BUILD_HASH=${{ needs.build.outputs.HASH }}
          OFFICIAL_HASH=${{ needs.official.outputs.HASH }}
          echo "Build hash: $BUILD_HASH"
          echo "Official hash: $OFFICIAL_HASH"
          if [ -z "$BUILD_HASH" ] || [ -z "$OFFICIAL_HASH" ]; then
            echo "One of the hashes is empty!"
            exit 1
          fi
          if [ "$BUILD_HASH" = "$OFFICIAL_HASH" ]; then
            echo "Hashes match!"
          else
            echo "Hashes do not match!"
            exit 1
          fi
