name: Telegram-Android

on:
  push:
    paths:
      - ".github/workflows/Telegram-Android.yml"

env:
  COMMIT: 9cbf03332a5a68fce3e616852d7dc929022c8441
  OFFICIAL_APK: https://filebin.net/5z8stlzqi7inuxcb/Telegram.apk.filebin
  OFFICIAL_SHA256: 156f956531d732b452b2d7b087d119250cbe19dc19d6fad9ba265543baa9b780

jobs:
  official:
    runs-on: ubuntu-latest
    steps:
      - name: Download
        run: |
          curl "${{ env.OFFICIAL_APK }}" -o Telegram.apk
          echo "$OFFICIAL_SHA256  Telegram.apk" | sha256sum -c -
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Telegram.apk
          path: Telegram.apk

  build:
    runs-on: ubuntu-latest
    needs: [official]
    steps:
      - name: Clone
        run: |
          git clone https://github.com/DrKLO/Telegram
          cd Telegram
          git checkout ${{ env.COMMIT }}
      - name: Dockerfile
        run: |
          cd Telegram
          docker build -t telegram-build .
      - name: Build
        run: |
          cd Telegram
          docker run --rm -v "$PWD":/home/gradle:Z -w /home/gradle telegram-build
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Telegram-${{ env.COMMIT }}.apk
          path: ./Telegram/TMessagesProj_AppStandalone/build/outputs/apk/afat/standalone/app.apk

  diff:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v5
        with:
          name: Telegram.apk
          path: Telegram.apk
      - name: Download artifact
        uses: actions/download-artifact@v5
        with:
          name: Telegram-${{ env.COMMIT }}.apk
          path: Telegram-${{ env.COMMIT }}.apk
      - name: ls
        run: |
          ls -Rlsah .
